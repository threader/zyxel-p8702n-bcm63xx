#!/usr/bin/perl
use strict;
use warnings;
use FindBin qw($Bin);
use lib "$Bin/../../PerlLib";
use BRCM::GenConfig;

# $p will allow us to GET values from the PROFILE
# $c will allow us to SET (and GET and DRIVER_SETUP) on the config
# file as we transform it from a template to the final config

# arguments 
# * profile file
# * config  file
my $p    = new BRCM::GenConfig(shift);
my $chip = $p->get('BRCM_CHIP');
my $c    = new BRCM::GenConfig( shift, Chip => $chip, Profile => $p );

############################################################
#   MTS Feature generation
############################################################
if ( $p->get("BUILD_MSTC_MODIFY") ) {
	$c->set( 'MSTC_MODIFY', 'y' );	
	
	if ( $p->get("MSTC_WEBUI_STYLE_BRICK") ) {
		$c->set( 'MSTC_WEBUI_STYLE_BRICK', 'y' );	
	}
	if ( $p->get("MSTC_WEBUI_STYLE_BRCM") ) {
		$c->set( 'MSTC_WEBUI_STYLE_BRCM', 'y' );	
	}
	if ( $p->get("MSTC_WEBUI_STYLE_BRICK_ODM") ) {
		$c->set( 'MSTC_WEBUI_STYLE_BRICK_ODM', 'y' );	
	}
	if ( $p->get("BUILD_MSTC_QoS") ) {
		$c->set( 'BUILD_MSTC_QoS', 'y' );	
	}
	if ( $p->get("LINUX_KERNEL_USBMASS") ) {
		$c->set( 'CONFIG_EXT2_FS', 'y' );	
		$c->set( 'CONFIG_EXT2_FS_XATTR', 'y' );	
	}

	if ( $p->get("BUILD_EBTABLES") ) {
		$c->set( 'CONFIG_BRIDGE_EBT_ARP', 'y' );	
		$c->set( 'CONFIG_BRIDGE_EBT_POLICER', 'y' );	
		$c->set( 'CONFIG_BRIDGE_EBT_AUTOMAP', 'y' );	
	}

	if ( $p->get("BUILD_IPV6") ) {
		$c->set( 'CONFIG_IP6_NF_TARGET_REJECT', 'm' );	
	}

	if ( $p->get("BUILD_HPNA") ) {
		$c->set( 'CONFIG_BUILD_HPNA', 'y' );	
	}

	if ( $p->get("MSTC_WDT") ) {
		$c->set( 'CONFIG_MSTC_WDT', 'y' );	
	}
	if ( $p->get("BUILD_NORWAY_VOIP_CUSTOMIZATION") ) {
		$c->set( 'CONFIG_MSTC_NORWAY_VOIP_CUSTOMIZATION', 'y' );	
	}
	if ( $p->get("BUILD_TELENOR_NORWAY_PORT_CHANGE") ) {
		$c->set( 'CONFIG_MSTC_TELENOR_NORWAY_PORT_CHANGE', 'y' );	
	}

	if ( $p->get("BUILD_MSTC_RECORD_CALL_TRACE") ) {
		$c->set( 'CONFIG_MSTC_RECORD_CALL_TRACE', 'y' );	
	}

	if ( $p->get("BUILD_MSTC_RECORD_CALL_TRACE_PATH_1") ) {
		$c->set( 'CONFIG_MSTC_RECORD_CALL_TRACE_PATH', '"/tmp/koops/"' );	
	}else{
		if ( $p->get("BUILD_MSTC_RECORD_CALL_TRACE_PATH_2") ) {
			$c->set( 'CONFIG_MSTC_RECORD_CALL_TRACE_PATH', '"/data/wtmp/"' );	
		}
	}

	if ( $p->get("BUILD_MSTC_OOPS_FILE_NUM") ) {
		$c->set( 'CONFIG_MSTC_OOPS_FILE_NUM', $p->get("BUILD_MSTC_OOPS_FILE_NUM") );	
	}

	if ( $p->get("BUILD_MSTC_DEC_AND_GZIP_CORE") ) {
		$c->set( 'CONFIG_ELF_CORE','y' );
		$c->set( 'CONFIG_MSTC_DEC_AND_GZIP_CORE','y' );	
	}

	if ( $p->get("BUILD_MSTC_ZLIB") ) {
		$c->set( 'CONFIG_MSTC_ZLIB','y' );
	}

	if ( $p->get("BUILD_MSTC_COREDUMP_FOLDER_PATH_1") ) {
		$c->set( 'CONFIG_MSTC_COREDUMP_FOLDER_PATH', '"/tmp/coredump/"' );
	}else{
		if ( $p->get("BUILD_MSTC_COREDUMP_FOLDER_PATH_2") ) {
			$c->set( 'CONFIG_MSTC_COREDUMP_FOLDER_PATH', '"/data/wtmp/"' );
		}
	}

	if ( $p->get("BUILD_MSTC_CORE_SIZE_PRE_THRESHOLD") ) {
		$c->set( 'CONFIG_MSTC_CORE_SIZE_PRE_THRESHOLD',$p->get("BUILD_MSTC_CORE_SIZE_PRE_THRESHOLD") );
	}

	if ( $p->get("BUILD_MSTC_CORE_SIZE_POST_THRESHOLD") ) {
		$c->set( 'CONFIG_MSTC_CORE_SIZE_POST_THRESHOLD',$p->get("BUILD_MSTC_CORE_SIZE_POST_THRESHOLD") );
	}
	if ( $p->get("BUILD_TELENOR_NORWAY_PORT_CHANGE") ) {
		$c->set( 'CONFIG_MSTC_TELENOR_NORWAY_PORT_CHANGE', 'y' );	
	}
	if ( $p->get("BUILD_MSTC_FIREWALL") ) {
		$c->set( 'CONFIG_IP_NF_TARGET_REJECT', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_HELPER', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_LENGTH', 'm' );	
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_TIME', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_RECENT', 'm' );	
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_PKTTYPE', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_IPRANGE', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_TARGET_NFQUEUE', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_TARGET_AUTOMAP', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_ETHER', 'm' );
		$c->set( 'CONFIG_NETFILTER_XT_POLICER', 'm' );		
		$c->set( 'CONFIG_NETFILTER_XT_MATCH_CONNLIMIT', 'm' );
		$c->set( 'CONFIG_IP6_NF_MATCH_FRAG', 'm' );			
	}
	
	if ( $p->get("BUILD_SIK_PARTITION_FEATURE") ) {
		$c->set( 'CONFIG_SIK_PARTITION_FEATURE',$p->get("BUILD_SIK_PARTITION_FEATURE") );
	}	

	if ( $p->get("BUILD_NORWAY_CUSTOMIZATION") ) {
		$c->set( 'CONFIG_BUILD_NORWAY_CUSTOMIZATION',$p->get("BUILD_NORWAY_CUSTOMIZATION") );
	}		
}

$c->write( );

